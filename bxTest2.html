<!DOCTYPE html>
<html>
<head>

    <script type="text/javascript" src="box2d.js"></script>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript">  
		$(document).ready(function() {
	
			//this code creates Box2D version of a Segway like vehicle
			
			
	
			var canvas,context,canvasOffset,viewCenterPixel,gravity,world,mouseJointGroundBody,myDebugDraw;
			var shape,ground;
			var PTM=10;
			
			
			
			canvas = document.getElementById("canvas");
			context = canvas.getContext( '2d' );
			canvasOffset = {x: canvas.width/2,y: canvas.height/2};   
			viewCenterPixel = {x:320,y:24};
			
			var globalStep = 0;
			
			var e_shapeBit = 0x0001;
			var e_jointBit = 0x0002;
			var e_aabbBit = 0x0004;
			var e_pairBit = 0x0008;
			var e_centerOfMassBit = 0x0010;
			
			function printStatus(message){
				$("#status").append(message+"<br/>");
			}
			
			
			function runLeft(force){				
				var forceVector = new Box2D.b2Vec2(-force,0.0);			
				b5.ApplyForceToCenter(forceVector);
			}
			function runRight(force){
				var forceVector = new Box2D.b2Vec2(force,0.0);			
				b5.ApplyForceToCenter(forceVector);
			}

			
			//define the debug draw function
			function drawAxes(ctx) {
				ctx.strokeStyle = 'rgb(192,0,0)';
				ctx.beginPath();
				ctx.moveTo(0, 0);
				ctx.lineTo(1, 0);
				ctx.stroke();
				ctx.strokeStyle = 'rgb(0,192,0)';
				ctx.beginPath();
				ctx.moveTo(0, 0);
				ctx.lineTo(0, 1);
				ctx.stroke();
			}
			
			
			function step() {
				world.Step(1/60, 3, 2);
				draw();
				//give it a kick
				if(globalStep == 50) runLeft(5000);

				globalStep += 1;
				var angle = joint.GetJointAngle();
				var speed = joint.GetJointSpeed();	
	
				printStatus("Step #"+globalStep+" angle="+angle+" speed="+speed);
				
				
				var hysterisis = 0.1;
				if(angle < -hysterisis){
					runRight( - angle  * 120000 );
				}else if (angle > hysterisis ){
					runLeft( angle * 120000);
				}
				
				
				if(angle < 1.5 && angle > -1.5)
				{
					setTimeout(function(){step()},10);
				}
				
			}

			function draw() {
				
				//black background
				context.fillStyle = 'rgb(0,0,0)';
				context.fillRect( 0, 0, canvas.width, canvas.height );
				
				context.save();            
					context.translate(canvasOffset.x, canvasOffset.y);
					context.scale(1,-1);                
					context.scale(PTM,PTM);
					context.lineWidth /= PTM;
					
					drawAxes(context);
					
					context.fillStyle = 'rgb(255,255,0)';
					world.DrawDebugData();
									
				context.restore();
			}	
			
			
			function setColorFromDebugDrawCallback( colorPtr ) {
				var color = Box2D.wrapPointer( colorPtr, Box2D.b2Color );
				var red = (color.get_r() * 255) | 0;
				var green = (color.get_g() * 255) | 0;
				var blue = (color.get_b() * 255) | 0;

				var colorStr = red + "," + green + "," + blue;
				context.fillStyle = "rgba(" + colorStr + ",0.5)";
				context.strokeStyle = "rgb(" + colorStr + ")";
			}

			function drawSegment( vert1Ptr, vert2Ptr ) {
				var vert1 = Box2D.wrapPointer( vert1Ptr, Box2D.b2Vec2 );
				var vert2 = Box2D.wrapPointer( vert2Ptr, Box2D.b2Vec2 );

				context.beginPath();
				context.moveTo( vert1.get_x(), vert1.get_y() );
				context.lineTo( vert2.get_x(), vert2.get_y() );
				context.stroke();
			}
			function drawPolygon(vertices, vertexCount, fill) {
				context.beginPath();
				var i=0;
				for(i=0;i<vertexCount;i++) {
					var vert = Box2D.wrapPointer(vertices+(i*8), Box2D.b2Vec2);
					if ( i == 0 )
						context.moveTo(vert.get_x(),vert.get_y());
					else
						context.lineTo(vert.get_x(),vert.get_y());
				}
				context.closePath();
				if (fill)
					context.fill();
				context.stroke();
			}
			
			//create world with gravity y=-10
			gravity = new Box2D.b2Vec2(0.0, -10.0) ;
			world = new Box2D.b2World( gravity );

			var debugDraw = new Box2D.b2Draw();
			
			var e_shapeBit = 0x0001;
			var e_jointBit = 0x0002;
			var e_aabbBit = 0x0004;
			var e_pairBit = 0x0008;
			var e_centerOfMassBit = 0x0010;
			
			
			debugDraw.SetFlags(e_shapeBit | e_jointBit);
			
			Box2D.customizeVTable(debugDraw, [{
				original: Box2D.b2Draw.prototype.DrawSegment,
				replacement:
					function(thsPtr, vert1Ptr, vert2Ptr, colorPtr ) {
						setColorFromDebugDrawCallback( colorPtr );
						drawSegment(vert1Ptr, vert2Ptr );
					}
			}]);
			Box2D.customizeVTable(debugDraw, [{
				original: Box2D.b2Draw.prototype.DrawPolygon,
				replacement:
					function(ths, vertices, vertexCount, color) {                    
						setColorFromDebugDrawCallback(color);
						drawPolygon(vertices, vertexCount, false);                    
					}
			}]);
			Box2D.customizeVTable(debugDraw, [{
				original: Box2D.b2Draw.prototype.DrawSolidPolygon,
				replacement:
					function(ths, vertices, vertexCount, color) {                    
						setColorFromDebugDrawCallback(color);
						drawPolygon(vertices, vertexCount, true);                    
					}
			}]);
			
			world.SetDebugDraw( debugDraw );

			
			//create a ground object
			PTM=20;
			canvasOffset.y = 480-10;
			//setViewCenterWorld( new Box2D.b2Vec2(0,8), true );
			
			shape = new Box2D.b2EdgeShape();
			shape.Set(new Box2D.b2Vec2(-30.0, 0.0), new Box2D.b2Vec2(30.0, 0.0));
			ground = world.CreateBody(new Box2D.b2BodyDef());
			ground.CreateFixture(shape, 0.0);

			
			//create two bodies and link them together
	        var boxShape = new Box2D.b2PolygonShape();
			boxShape.SetAsBox(1,1);
			var bd = new Box2D.b2BodyDef();
			bd.set_type(Box2D.b2_dynamicBody);
			bd.set_position(new Box2D.b2Vec2(0.0, 7.0));
			var b4 = world.CreateBody(bd);
			b4.CreateFixture(boxShape, 10.0);
			
			var boxShape2 = new Box2D.b2PolygonShape();
			boxShape2.SetAsBox(1,1);
			var bd2 = new Box2D.b2BodyDef();
			bd2.set_type(Box2D.b2_dynamicBody);
			bd2.set_position(new Box2D.b2Vec2(0.0, 1.0));
			var b5 = world.CreateBody(bd2);
			b5.CreateFixture(boxShape, 10.0);

			var jd = new Box2D.b2RevoluteJointDef();
			var anchor = new Box2D.b2Vec2(0.0, 1.0);
			jd.Initialize(b5, b4, anchor);
			var joint = Box2D.castObject(world.CreateJoint(jd),Box2D.b2RevoluteJoint);
			
		
			printStatus();

			
			setTimeout(function(){step()},10);
		});
	</script>

</head>

<body>
	<canvas id='canvas' width="640" height="480"></canvas>
	<div id="status">asdfasdf</div>
</body>
</html>